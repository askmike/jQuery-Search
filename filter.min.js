/* jQuery search plugin */
(function(a){a.fn.search=function(b){var c=[],d,e=this.data("search"),f=this,g;if(typeof b==="string"){c=b.split(" ")}else if(typeof b==="array"){c=b}else if(typeof b==="object"){d=b}var h=a.extend({container:"#templates",single:".single",singleStructure:[{elem:"h3",score:3},{elem:"textarea",score:1}]},d),e=f.data("search"),i=true;if(!e){var j=a(h.container);i=false;e={search:f,singleElems:[],templates:[],included:[],scoreBoard:[],container:j,singles:j.find(h.single),settings:h};var k=function(){var b=e.settings.singleStructure;for(var c=b.length,d=0;d<c;d++){e.scoreBoard.push(b[d].score);e.singleElems.push(b[d].elem)}e.singles.detach().each(function(b){a(this).data("position",b);var c=[];for(var d=e.singleElems.length,f=0;f<d;f++){c.push(e.singles.eq(b).find(e.singleElems[f]).text())}e.templates.push({text:c,score:0})}).appendTo(e.container);o();g=e.templates.length;f.data("search",e)}}var l=function(b){m();for(var c=b.length,d=0;d<c;d++){var f=b[d];for(var g=e.templates.length,h=0;h<g;h++){var i=e.templates[h],j=new RegExp("\\b"+f+"\\b","gi");for(var k=e.singleElems.length,l=0;l<k;l++){if(j.test(i.text[l])){i.score+=e.scoreBoard[l];if(a.inArray(h,e.included)<0){e.included.push(h)}}}}}var o=b.length;n(o)},m=function(){for(var a=e.templates.length;a--;){e.templates[a].score=0}},n=function(b){function d(b,c){return a(b).data("position")>a(c).data("position")?1:-1}function c(b,c){return a(b).data("score")<a(c).data("score")?1:-1}g=0;e.singles.detach().sort(d).each(function(c){var d=a(this);d.hide().data("score",e.templates[c].score);if(a.inArray(c,e.included)!=-1&&b<=e.templates[c].score){d.show();g++}});e.singles.sort(c);e.container.append(e.singles);e.singles=e.container.find(e.settings.single)},o=function(){var a=e.search;a.keyup(function(b){if(a.val()==""){l([" "]);return}if(b.which==32){var c=[],d=a.val().split(" ");for(var e=0,f=d.length;e<f;e++){if(d[e]!=""){c.push(d[e])}}l(c)}})},p=function(a,b){l(a);if(!b&&a[0]!=" "){var c=a.join(" ")+" ";e.search.val(c)}};if(!i){k()}if(c.length){l(c)}return g}})(jQuery)
